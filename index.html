<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPO/APO Calculator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900">
    <!-- This is the root element where the React application will be mounted. -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- Custom Hook for Undo/Redo State Management ---
        const useHistory = (initialState) => {
            const [history, setHistory] = useState([initialState]);
            const [currentIndex, setCurrentIndex] = useState(0);

            const setState = (newState, overwrite = false) => {
                const newHistory = overwrite 
                    ? [...history.slice(0, currentIndex), newState] 
                    : [...history.slice(0, currentIndex + 1), newState];
                
                setHistory(newHistory);
                setCurrentIndex(newHistory.length - 1);
            };

            const undo = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                }
            };

            const redo = () => {
                if (currentIndex < history.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                }
            };

            return {
                state: history[currentIndex],
                setState,
                undo,
                redo,
                canUndo: currentIndex > 0,
                canRedo: currentIndex < history.length - 1,
            };
        };


        // --- Helper Components ---
        const Tooltip = ({ children, text }) => {
          const [show, setShow] = useState(false);
          return (
            <div className="relative flex items-center" onMouseEnter={() => setShow(true)} onMouseLeave={() => setShow(false)}>
              {children}
              {show && (
                <div className="absolute bottom-full mb-2 px-2 py-1 text-sm text-white bg-gray-700 rounded-md shadow-lg z-10 whitespace-nowrap">
                  {text}
                </div>
              )}
            </div>
          );
        };

        const EditableNumericCell = ({ value, onCommit }) => {
            const [displayValue, setDisplayValue] = useState(String(value));

            useEffect(() => {
                if (parseFloat(displayValue) !== value && !isNaN(value)) {
                    setDisplayValue(String(value));
                }
            }, [value]);

            const handleChange = (e) => {
                setDisplayValue(e.target.value);
            };

            const handleBlur = () => {
                onCommit(parseFloat(displayValue) || 0);
            };

            return (
                <input
                    type="text"
                    value={displayValue}
                    onChange={handleChange}
                    onBlur={handleBlur}
                    className="bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-1 text-right"
                />
            );
        };

        // --- Modal for pasting data from a spreadsheet (Upgraded with Checkboxes) ---
        const PasteDataModal = ({ isOpen, onClose, onPaste }) => {
            const [pastedText, setPastedText] = useState('');
            const [fieldsToUpdate, setFieldsToUpdate] = useState({
                preElectionWI: true,
                preElectionNRI: true,
                electionCode: false,
                umi: false,
            });
            
            const fieldDisplayNames = {
                preElectionWI: 'WI',
                preElectionNRI: 'NRI',
                electionCode: 'Election Code',
                umi: 'UMI',
            };

            const orderedFields = useMemo(() => {
                const order = ['preElectionWI', 'preElectionNRI', 'electionCode', 'umi'];
                return order.filter(field => fieldsToUpdate[field]);
            }, [fieldsToUpdate]);

            if (!isOpen) return null;

            const handleFieldToggle = (field) => {
                setFieldsToUpdate(prev => ({ ...prev, [field]: !prev[field] }));
            };

            const handleImport = () => {
                onPaste(pastedText, fieldsToUpdate);
                onClose();
                setPastedText('');
            };
            
            const getExpectedColumnsText = () => {
                const fieldNames = {
                    preElectionWI: 'WI',
                    preElectionNRI: 'NRI',
                    electionCode: 'Election Code',
                    umi: 'UMI (Yes/No)',
                };
                const columns = ['Entity Name', ...orderedFields.map(f => fieldNames[f])];
                return `Expected columns: ${columns.join(', ')}`;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl">
                        <h2 className="text-xl font-bold text-white mb-4">Paste Spreadsheet Data</h2>
                        
                        <div className="mb-4 p-3 bg-gray-700 rounded-lg">
                            <label className="block text-sm font-medium text-gray-300 mb-2">Fields to Paste (Entity Name is always first):</label>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.keys(fieldsToUpdate).map(field => (
                                    <label key={field} className="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" checked={fieldsToUpdate[field]} onChange={() => handleFieldToggle(field)} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-blue-500 focus:ring-blue-500"/>
                                        <span className="text-gray-200">{fieldDisplayNames[field]}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        <p className="text-gray-400 mb-4">{getExpectedColumnsText()}</p>
                        
                        <textarea
                            className="w-full h-40 bg-gray-900 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={pastedText}
                            onChange={(e) => setPastedText(e.target.value)}
                            placeholder="Paste your tab-separated data here..."
                        ></textarea>
                        <div className="mt-6 flex justify-end gap-4">
                            <button onClick={onClose} className="py-2 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg transition">Cancel</button>
                            <button onClick={handleImport} className="py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Import Data</button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Initial Data & Core Logic ---
        const getInitialParties = () => [
            { id: 1, entityName: 'Big Oil Co.', preElectionWI: 0.50, preElectionNRI: 0.4375, electionCode: '3', umi: false },
            { id: 2, entityName: 'Small Operator LLC', preElectionWI: 0.25, preElectionNRI: 0.21875, electionCode: '1', umi: false },
            { id: 3, entityName: 'Non-Consent Partner', preElectionWI: 0.15, preElectionNRI: 0.13125, electionCode: '1', umi: false },
            { id: 4, entityName: 'Force-Pooled UMI', preElectionWI: 0.10, preElectionNRI: 0.0875, electionCode: '0', umi: true },
        ];

        const getNewProject = (title) => ({
            id: Date.now(),
            title: title,
            isApo: false,
            parties: getInitialParties(),
        });

        const calculateResults = (parties, isApo) => {
            const round = (num) => Math.round((num + Number.EPSILON) * 1e8) / 1e8;
            
            if (isApo) {
                const calculatedParties = parties.map(p => ({
                    ...p,
                    resultingBPOWI: p.preElectionWI,
                    resultingBPONRI: p.preElectionNRI,
                    additionalWIAcquired: 0,
                    additionalNRIAcquired: 0,
                }));
                const totalResultingWI = calculatedParties.reduce((sum, p) => sum + p.resultingBPOWI, 0);
                const totalResultingNRI = calculatedParties.reduce((sum, p) => sum + p.resultingBPONRI, 0);
                return { 
                    calculatedParties, 
                    summary: {
                        consentWI: round(totalResultingWI), consentNRI: round(totalResultingNRI),
                        nonConsentWI: 0, nonConsentNRI: 0,
                        totalWI: round(totalResultingWI), totalNRI: round(totalResultingNRI),
                        wiFlag: Math.abs(round(totalResultingWI) - 1.0) > 1e-8,
                        absorptionFlag: false,
                    } 
                };
            }

            let nonConsentWI_pool = 0, nonConsentNRI_pool = 0;
            const consentingParties = [], excessCarryingParties = [];

            parties.forEach(p => {
                const isNonConsent = p.electionCode === '0';
                const isUmiBPO = p.umi && !isApo;
                if (isNonConsent || isUmiBPO) {
                    nonConsentWI_pool += p.preElectionWI;
                    if (!p.umi) nonConsentNRI_pool += p.preElectionNRI;
                }
                if (['1', '2', '3'].includes(p.electionCode)) {
                    consentingParties.push(p);
                    if (p.electionCode === '3') excessCarryingParties.push(p);
                }
            });

            const totalConsentingWI = consentingParties.reduce((sum, p) => sum + p.preElectionWI, 0);
            const totalExcessCarryingWI = excessCarryingParties.reduce((sum, p) => sum + p.preElectionWI, 0);
            let unclaimedWI = 0, unclaimedNRI = 0;
            const acquisitions = {};

            if (totalConsentingWI > 0) {
                consentingParties.forEach(p => {
                    const proportionalShareWI = (p.preElectionWI / totalConsentingWI) * nonConsentWI_pool;
                    const proportionalShareNRI = (p.preElectionWI / totalConsentingWI) * nonConsentNRI_pool;
                    if (p.electionCode === '1') {
                        unclaimedWI += proportionalShareWI;
                        unclaimedNRI += proportionalShareNRI;
                        acquisitions[p.id] = { wi: 0, nri: 0 };
                    } else {
                        acquisitions[p.id] = { wi: proportionalShareWI, nri: proportionalShareNRI };
                    }
                });
            }

            if (unclaimedWI > 0 && totalExcessCarryingWI > 0) {
                excessCarryingParties.forEach(p => {
                    const excessShare = (p.preElectionWI / totalExcessCarryingWI);
                    acquisitions[p.id].wi += unclaimedWI * excessShare;
                    acquisitions[p.id].nri += unclaimedNRI * excessShare;
                });
            }

            const calculatedParties = parties.map(p => {
                let resultingBPOWI = 0, resultingBPONRI = 0;
                const additionalWIAcquired = acquisitions[p.id]?.wi || 0;
                const additionalNRIAcquired = acquisitions[p.id]?.nri || 0;

                if (p.umi && !isApo) {
                    resultingBPOWI = 0;
                    resultingBPONRI = round(p.preElectionWI * 0.16);
                } else if (p.electionCode === '0') {
                    resultingBPOWI = 0;
                    resultingBPONRI = 0;
                } else {
                    resultingBPOWI = p.preElectionWI + additionalWIAcquired;
                    resultingBPONRI = p.preElectionNRI + additionalNRIAcquired;
                }
                return { ...p, resultingBPOWI: round(resultingBPOWI), resultingBPONRI: round(resultingBPONRI), additionalWIAcquired: round(additionalWIAcquired), additionalNRIAcquired: round(additionalNRIAcquired) };
            });
            
            const totalResultingWI = calculatedParties.reduce((sum, p) => sum + p.resultingBPOWI, 0);
            const totalResultingNRI = calculatedParties.reduce((sum, p) => sum + p.resultingBPONRI, 0);
            const totalNonConsentWI = parties.reduce((sum, p) => (p.electionCode === '0' || (p.umi && !isApo)) ? sum + p.preElectionWI : sum, 0);
            const totalNonConsentNRI = parties.reduce((sum, p) => (p.electionCode === '0' && !p.umi) ? sum + p.preElectionNRI : sum, 0);
            
            const summary = {
                consentWI: round(totalResultingWI), consentNRI: round(totalResultingNRI),
                nonConsentWI: round(totalNonConsentWI), nonConsentNRI: round(totalNonConsentNRI),
                totalWI: round(totalResultingWI), totalNRI: round(totalResultingNRI),
                wiFlag: Math.abs(round(totalResultingWI) - 1.0) > 1e-8,
                absorptionFlag: Math.abs(round(nonConsentWI_pool) - round(calculatedParties.reduce((sum, p) => sum + p.additionalWIAcquired, 0))) > 1e-8,
            };
            
            return { calculatedParties, summary };
        };


        // --- Main Application Component ---
        const App = () => {
            const { state: projects, setState: setProjects, undo, redo, canUndo, canRedo } = useHistory([getNewProject('BPO/APO Interest Calculator')]);
            const [activeProjectId, setActiveProjectId] = useState(projects[0].id);
            const [isExportReady, setIsExportReady] = useState(false);
            const [isPasteModalOpen, setIsPasteModalOpen] = useState(false);
            const [columnWidths, setColumnWidths] = useState([250, 150, 80, 150, 150, 150, 150, 180, 180, 80]);
            const resizingColumnIndex = useRef(null);
            const fileInputRef = useRef(null);

            const activeProject = useMemo(() => projects.find(p => p.id === activeProjectId) || projects[0], [projects, activeProjectId]);
            const { calculatedParties, summary } = useMemo(() => activeProject ? calculateResults(activeProject.parties, activeProject.isApo) : { calculatedParties: [], summary: {} }, [activeProject]);

            useEffect(() => {
                const scriptId = 'xlsx-script';
                if (!document.getElementById(scriptId)) {
                    const script = document.createElement('script');
                    script.id = scriptId;
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
                    script.async = true;
                    script.onload = () => setIsExportReady(true);
                    document.body.appendChild(script);
                } else {
                    setIsExportReady(true);
                }
            }, []);

            const updateProject = (projectId, updatedData) => {
                const newProjects = projects.map(p => p.id === projectId ? { ...p, ...updatedData } : p);
                setProjects(newProjects);
            };
            
            const updateParties = (newParties) => {
                const newProjects = projects.map(p => p.id === activeProjectId ? { ...p, parties: newParties } : p);
                setProjects(newProjects);
            };

            const handleAddProject = () => {
                const newProj = getNewProject('New Project');
                setProjects([...projects, newProj]);
                setActiveProjectId(newProj.id);
            };

            const handleDuplicateProject = () => {
                if (!activeProject) return;
                const newProj = { ...JSON.parse(JSON.stringify(activeProject)), id: Date.now(), title: `${activeProject.title} (Copy)` };
                setProjects([...projects, newProj]);
                setActiveProjectId(newProj.id);
            };

            const handleDeleteProject = () => {
                if (projects.length <= 1) { alert("You cannot delete the last project."); return; }
                const remainingProjects = projects.filter(p => p.id !== activeProjectId);
                setProjects(remainingProjects);
                setActiveProjectId(remainingProjects[0].id);
            };

            const handlePartyChange = (id, field, value) => {
                const newParties = activeProject.parties.map(p => p.id === id ? { ...p, [field]: value } : p);
                updateParties(newParties);
            };

            const addParty = () => {
                const newParty = { id: Date.now(), entityName: 'New Party', preElectionWI: 0, preElectionNRI: 0, electionCode: '1', umi: false };
                updateParties([...activeProject.parties, newParty]);
            };

            const removeParty = (id) => {
                updateParties(activeProject.parties.filter(p => p.id !== id));
            };

            const handlePasteData = (pastedText, fieldsToUpdate) => {
                const MAX_ROWS = 5000;
                let rows = pastedText.trim().split('\n');
                
                let warning = '';
                if (rows.length > MAX_ROWS) {
                    warning = `Pasted data exceeds 5,000 rows. Only the first 5,000 will be imported.\n\n`;
                    rows = rows.slice(0, MAX_ROWS);
                }

                const errors = [];
                let addedCount = 0;
                let updatedCount = 0;
                
                const newParties = [...activeProject.parties];
                const existingPartiesMap = new Map(newParties.map(p => [p.entityName.trim().toLowerCase(), p]));

                rows.forEach((row, index) => {
                    const delimiter = row.includes('\t') ? '\t' : ',';
                    const columns = row.split(delimiter).map(c => c.trim().replace(/^"|"$/g, ''));

                    const cleanNumber = (str) => {
                        if (typeof str !== 'string' || !str) return NaN;
                        let cleaned = str.replace(/,/g, '.'); // Handle European comma
                        if (cleaned.split('.').length > 2) { // Handle thousand separators
                             cleaned = cleaned.replace(/\.(?=.*\.)/g, '');
                        }
                        if (cleaned.endsWith('%')) {
                            cleaned = parseFloat(cleaned) / 100;
                        }
                        return parseFloat(cleaned);
                    };

                    const name = columns[0].trim();
                    if (!name) { errors.push(`Row ${index + 1}: Skipped - Entity Name is missing.`); return; }

                    const existingParty = existingPartiesMap.get(name.toLowerCase());
                    let partyToUpdate = existingParty;

                    if (!partyToUpdate) {
                        partyToUpdate = { id: Date.now() + index, entityName: name, preElectionWI: 0, preElectionNRI: 0, electionCode: '1', umi: false };
                        newParties.push(partyToUpdate);
                        existingPartiesMap.set(name.toLowerCase(), partyToUpdate);
                        addedCount++;
                    } else {
                        updatedCount++;
                    }
                    
                    let colIndex = 1;
                    if (fieldsToUpdate.preElectionWI) {
                        const wi = cleanNumber(columns[colIndex]);
                        if (isNaN(wi) || wi < 0 || wi > 1) { errors.push(`Row ${index + 1} ('${name}'): Skipped - Invalid WI value '${columns[colIndex]}'.`); return; }
                        partyToUpdate.preElectionWI = wi;
                        colIndex++;
                    }
                    if (fieldsToUpdate.preElectionNRI) {
                         const nri = cleanNumber(columns[colIndex]);
                        if (isNaN(nri) || nri < 0 || nri > 1) { errors.push(`Row ${index + 1} ('${name}'): Skipped - Invalid NRI value '${columns[colIndex]}'.`); return; }
                        partyToUpdate.preElectionNRI = nri;
                        colIndex++;
                    }
                    if (fieldsToUpdate.electionCode) {
                        const code = columns[colIndex];
                        if (['0', '1', '2', '3'].includes(code)) {
                            partyToUpdate.electionCode = code;
                        }
                        colIndex++;
                    }
                    if (fieldsToUpdate.umi) {
                        const umiVal = columns[colIndex]?.toLowerCase();
                        if (['true', 'yes', '1'].includes(umiVal)) partyToUpdate.umi = true;
                        if (['false', 'no', '0'].includes(umiVal)) partyToUpdate.umi = false;
                        colIndex++;
                    }
                });

                updateParties(newParties);

                let feedbackMessage = `${warning}Import complete.\n- Added: ${addedCount} rows\n- Updated: ${updatedCount} rows`;
                if (errors.length > 0) {
                    feedbackMessage += `\n- Skipped: ${errors.length} rows with errors:\n\n${errors.join('\n')}`;
                }
                alert(feedbackMessage);
            };

            const handleExport = () => {
                // ... (Export logic remains the same)
            };
            
            const handleMouseDown = useCallback((index) => (e) => { resizingColumnIndex.current = index; }, []);
            const handleMouseMove = useCallback((e) => {
                if (resizingColumnIndex.current !== null) {
                    setColumnWidths(prev => {
                        const newWidths = [...prev];
                        newWidths[resizingColumnIndex.current] = Math.max(50, newWidths[resizingColumnIndex.current] + e.movementX);
                        return newWidths;
                    });
                }
            }, []);
            const handleMouseUp = useCallback(() => { resizingColumnIndex.current = null; }, []);

            useEffect(() => {
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [handleMouseMove, handleMouseUp]);

            const handleColumnAutoSize = useCallback((index) => {
                // ... (Auto-size logic remains the same)
            }, [calculatedParties]);

            const handleImportClick = () => { fileInputRef.current.click(); };

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase() === 'party detail');
                    if (!sheetName) {
                        alert("Could not find a 'Party Detail' sheet in the imported file.");
                        return;
                    }
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    const newParties = jsonData.map((row, index) => ({
                        id: Date.now() + index,
                        entityName: row['Entity Name'] || '',
                        electionCode: String(row['Election Code'] || '1'),
                        umi: String(row['UMI']).toLowerCase() === 'yes',
                        preElectionWI: parseFloat(row['Pre-Election WI']) || 0,
                        preElectionNRI: parseFloat(row['Pre-Election NRI']) || 0,
                    }));

                    const newProject = {
                        id: Date.now(),
                        title: file.name.replace('.xlsx', ''),
                        isApo: false,
                        parties: newParties,
                    };

                    setProjects([...projects, newProject]);
                    setActiveProjectId(newProject.id);
                };
                reader.readAsArrayBuffer(file);
                e.target.value = ''; // Reset file input
            };


            if (!activeProject) {
                return (
                     <div className="flex items-center justify-center h-full bg-gray-900">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold text-white">No Projects Exist</h1>
                            <p className="text-gray-400 mt-2">Create a new project to get started.</p>
                            <button onClick={handleAddProject} className="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Create Project</button>
                        </div>
                    </div>
                )
            }
            
            const tableHeaders = [
                'Entity Name', 'Election Code', 'UMI', 
                'Pre-Election WI', 'Pre-Election NRI', 
                'Add\'l WI Acquired', 'Add\'l NRI Acquired', 
                activeProject.isApo ? 'Resulting APO WI' : 'Resulting BPO WI', 
                activeProject.isApo ? 'Resulting APO NRI' : 'Resulting BPO NRI', 
                'Actions'
            ];

            return (
                <>
                    <PasteDataModal isOpen={isPasteModalOpen} onClose={() => setIsPasteModalOpen(false)} onPaste={handlePasteData} />
                    <input type="file" ref={fileInputRef} onChange={handleFileImport} style={{ display: 'none' }} accept=".xlsx" />
                    <div className="bg-gray-900 text-gray-200 min-h-screen font-sans p-4 sm:p-6 lg:p-8">
                        <div className="max-w-7xl mx-auto">
                            <header className="mb-4">
                                <input type="text" value={activeProject.title} onChange={(e) => updateProject(activeProjectId, { title: e.target.value })} className="text-3xl font-bold text-white bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-2 py-1 -ml-2" />
                            </header>
                            
                            <div className="flex flex-col md:flex-row md:flex-wrap justify-between items-center mb-4 bg-gray-800 p-4 rounded-lg shadow-md gap-4">
                                <div className="flex items-center gap-2">
                                     <label htmlFor="project-select" className="text-sm font-bold text-gray-300">Project:</label>
                                    <select id="project-select" value={activeProjectId} onChange={(e) => setActiveProjectId(Number(e.target.value))} className="bg-gray-700 text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        {projects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                                    </select>
                                    <Tooltip text="New Project"><button onClick={handleAddProject} className="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clipRule="evenodd" /></svg></button></Tooltip>
                                    <Tooltip text="Duplicate Project"><button onClick={handleDuplicateProject} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" /></svg></button></Tooltip>
                                     <Tooltip text="Delete Project"><button onClick={handleDeleteProject} disabled={projects.length <= 1} className="bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button></Tooltip>
                                </div>
                                <div className="flex items-center gap-4">
                                     <Tooltip text="Undo"><button onClick={undo} disabled={!canUndo} className="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 2a.75.75 0 01.75.75v6.19l1.72-1.72a.75.75 0 111.06 1.06l-3 3a.75.75 0 01-1.06 0l-3-3a.75.75 0 111.06-1.06l1.72 1.72V2.75A.75.75 0 0110 2zM5.155 6.25A.75.75 0 016 6h8a.75.75 0 010 1.5H6a.75.75 0 01-.845-.75z" clipRule="evenodd" /></svg></button></Tooltip>
                                     <Tooltip text="Redo"><button onClick={redo} disabled={!canRedo} className="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a.75.75 0 01-.75-.75V11.06l-1.72 1.72a.75.75 0 11-1.06-1.06l3-3a.75.75 0 011.06 0l3 3a.75.75 0 11-1.06 1.06l-1.72-1.72v6.19a.75.75 0 01-.75.75zM5.155 13.75A.75.75 0 016 14h8a.75.75 0 010-1.5H6a.75.75 0 01-.845.75z" clipRule="evenodd" /></svg></button></Tooltip>
                                     <Tooltip text="Add Party"><button onClick={addParty} className="bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg></button></Tooltip>
                                    <Tooltip text="Paste Data"><button onClick={() => setIsPasteModalOpen(true)} className="bg-orange-600 hover:bg-orange-700 text-white font-bold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button></Tooltip>
                                    <Tooltip text="Import Project"><button onClick={handleImportClick} className="bg-teal-600 hover:bg-teal-700 text-white font-bold p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3.382l-.724-1.447A1 1 0 0011 16H9a1 1 0 00-.894.553L7.382 18H4a2 2 0 01-2-2V4zm5 3a1 1 0 011-1h2a1 1 0 110 2H10a1 1 0 01-1-1zm-1 4a1 1 0 100 2h4a1 1 0 100-2H8z" clipRule="evenodd" /></svg></button></Tooltip>
                                    <Tooltip text="Export to XLSX"><button onClick={handleExport} disabled={!isExportReady} className="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg disabled:bg-gray-500"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" /></svg></button></Tooltip>
                                </div>
                                {/* APO/BPO Toggle */}
                                <div className="flex items-center">
                                    <span className={`mr-3 font-medium ${!activeProject.isApo ? 'text-blue-400' : 'text-gray-500'}`}>BPO</span>
                                    <label className="flex items-center cursor-pointer">
                                        <div className="relative"><input type="checkbox" className="sr-only" checked={activeProject.isApo} onChange={() => updateProject(activeProjectId, { isApo: !activeProject.isApo })} /><div className="block bg-gray-600 w-14 h-8 rounded-full"></div><div className={`dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform ${activeProject.isApo ? 'transform translate-x-full' : ''}`}></div></div>
                                    </label>
                                    <span className={`ml-3 font-medium ${activeProject.isApo ? 'text-blue-400' : 'text-gray-500'}`}>APO</span>
                                </div>
                            </div>
                            <div className="overflow-x-auto bg-gray-800 rounded-lg shadow-lg">
                                <table className="min-w-full divide-y divide-gray-700 table-fixed">
                                    <thead className="bg-gray-700">
                                        <tr>
                                            {tableHeaders.map((h, i) => (
                                                <th 
                                                    key={h} 
                                                    className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider relative"
                                                    style={{ width: `${columnWidths[i]}px` }}
                                                    onDoubleClick={() => handleColumnAutoSize(i)}
                                                >
                                                    {h}
                                                     <div 
                                                        className="absolute top-0 right-0 h-full w-2 cursor-col-resize"
                                                        onMouseDown={handleMouseDown(i)}
                                                    />
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="bg-gray-800 divide-y divide-gray-700">
                                        {calculatedParties.map(p => <PartyRow key={p.id} party={p} onPartyChange={handlePartyChange} onRemove={removeParty} columnWidths={columnWidths} />)}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-6 p-4 bg-gray-800 rounded-lg shadow-md">
                                <h2 className="text-xl font-semibold mb-4 text-white">Calculation Summary</h2>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <SummaryCard title="Consent WI" value={summary.consentWI} /><SummaryCard title="Consent NRI" value={summary.consentNRI} />
                                    <SummaryCard title="Non-Consent WI" value={summary.nonConsentWI} /><SummaryCard title="Non-Consent NRI" value={summary.nonConsentNRI} />
                                </div>
                                <div className="mt-4 border-t border-gray-700 pt-4">
                                    <h3 className="text-lg font-semibold text-white">Totals & Validation</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                                        <SummaryCard title="Total Resulting WI" value={summary.totalWI} flag={summary.wiFlag} flagText="Total WI should be 1.0" />
                                        <SummaryCard title="Total Resulting NRI" value={summary.totalNRI} />
                                        <SummaryCard title="Unabsorbed WI" value={summary.absorptionFlag ? 'Error' : 'None'} flag={summary.absorptionFlag} flagText="Non-Consent WI not fully absorbed." />
                                    </div>
                                </div>
                            </div>
                            <ElectionCodeKey />
                        </div>
                    </div>
                </>
            );
        };

        const PartyRow = ({ party, onPartyChange, onRemove, columnWidths }) => {
            const electionCodeColor = { '0': 'bg-red-900', '1': 'bg-blue-900', '2': 'bg-green-900', '3': 'bg-teal-900' };
            const umiTooltipText = "Unleased Mineral Interest (Force-Pooled): Before payout, owner has 0% WI and a fixed 16% NRI. Their costs are carried by consenting parties. After payout, they can convert to their full participating interest.";
            return (
                <tr className="hover:bg-gray-700 transition-colors duration-150">
                    <td style={{ width: `${columnWidths[0]}px` }} className="px-4 py-2"><input type="text" value={party.entityName} onChange={e => onPartyChange(party.id, 'entityName', e.target.value)} className="bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-1" /></td>
                    <td style={{ width: `${columnWidths[1]}px` }} className="px-4 py-2"><select value={party.electionCode} onChange={e => onPartyChange(party.id, 'electionCode', e.target.value)} className={`w-full focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-2 py-1 text-white border-none ${electionCodeColor[party.electionCode]}`}><option value="0">0 - Non-Consent</option><option value="1">1 - Participate</option><option value="2">2 - Carry</option><option value="3">3 - Carry + Excess</option></select></td>
                    <td style={{ width: `${columnWidths[2]}px` }} className="px-4 py-2 text-center"><Tooltip text={umiTooltipText}><input type="checkbox" checked={party.umi} onChange={e => onPartyChange(party.id, 'umi', e.target.checked)} className="h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" /></Tooltip></td>
                    
                    <td style={{ width: `${columnWidths[3]}px` }} className="px-4 py-2">
                        <EditableNumericCell value={party.preElectionWI} onCommit={(newValue) => onPartyChange(party.id, 'preElectionWI', newValue)} />
                    </td>
                    <td style={{ width: `${columnWidths[4]}px` }} className="px-4 py-2">
                        <EditableNumericCell value={party.preElectionNRI} onCommit={(newValue) => onPartyChange(party.id, 'preElectionNRI', newValue)} />
                    </td>

                    {[
                        { field: 'additionalWIAcquired', index: 5 }, { field: 'additionalNRIAcquired', index: 6 },
                        { field: 'resultingBPOWI', index: 7 }, { field: 'resultingBPONRI', index: 8 },
                    ].map(({ field, index }) => (
                        <td key={field} style={{ width: `${columnWidths[index]}px` }} className="px-4 py-2">
                            <span className={`w-full block text-right px-1 ${field.includes('WI') ? 'text-green-400' : 'text-yellow-400'} font-mono`}>{party[field]?.toFixed(8) || '0.00000000'}</span>
                        </td>
                    ))}
                    <td style={{ width: `${columnWidths[9]}px` }} className="px-4 py-2 text-center"><button onClick={() => onRemove(party.id)} className="text-red-500 hover:text-red-400 font-bold">&times;</button></td>
                </tr>
            );
        };

        const SummaryCard = ({ title, value, flag = false, flagText = '' }) => (
            <div className={`p-3 rounded-lg ${flag ? 'bg-red-500/20' : 'bg-gray-700'}`}>
                <p className="text-sm text-gray-400">{title}</p>
                <p className={`text-lg font-bold ${flag ? 'text-red-400' : 'text-white'} font-mono`}>{typeof value === 'number' ? value.toFixed(8) : value}</p>
                {flag && <p className="text-xs text-red-400 mt-1">{flagText}</p>}
            </div>
        );

        const ElectionCodeKey = () => (
            <div className="mt-6 p-4 bg-gray-800 rounded-lg shadow-md">
                <h2 className="text-xl font-semibold mb-4 text-white">Election Code Key</h2>
                <div className="space-y-3">
                    {[
                        { code: '0', name: 'Non-Consent', desc: 'Party elects not to participate. Their interest is offered to consenting parties.', color: 'bg-red-900' },
                        { code: '1', name: 'Participate', desc: 'Party pays its share and does not carry any non-consent interest.', color: 'bg-blue-900' },
                        { code: '2', name: 'Carry', desc: 'Party pays its share and carries a proportionate part of the non-consent interest.', color: 'bg-green-900' },
                        { code: '3', name: 'Carry + Excess', desc: 'Party pays its share, carries its proportionate part, and any excess non-consent interest.', color: 'bg-teal-900' },
                    ].map(item => (
                        <div key={item.code} className="flex items-start gap-4">
                            <div className={`flex-shrink-0 w-32 text-center text-sm font-bold py-1 rounded ${item.color}`}>{`Code ${item.code}: ${item.name}`}</div>
                            <p className="text-gray-300 text-sm">{item.desc}</p>
                        </div>
                    ))}
                </div>
            </div>
        );

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
